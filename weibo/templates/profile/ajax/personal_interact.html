{% extends 'profile/ajax/ajax_layout.html' %}

{% block body %}
<style>
    #container {
        width: 900px;
        height: 600px;
        margin:0 auto;
        position:relative;
    }

    #right-container, #center-container {
        height: 480px;
        position: relative;
    }

    #right-container {
        width:200px;
        color:#686c70;
        text-align: left;
        overflow: auto;
        background-color:#fff;
        background-repeat:no-repeat;
        border-bottom:1px solid #ddd;
    }


    #right-container {
        right:0;
        background-position:center left;
        border-right:1px solid #ddd;
    }

    #right-container h4{
        text-indent:8px;
    }

    .text {
        margin: 7px;
    }

    #inner-details {
        position: relative;
        font-size:0.8em;
        color:#000000;
        list-style:none;
        padding-top: 44px;
        margin:7px;
        border: 1px solid #e3e3e3;
    }

    #log {
        position:absolute;
        top:10px;
        font-size:1.0em;
        font-weight:bold;
        color:#23A4FF;
    }

    #infovis {
        position:relative;
        /*width:500px;*/
        height:500px;
        margin: 0 auto;
        /*overflow:hidden;*/
    }

    /*TOOLTIPS*/
    .tip {
        color: #111;
        width: 139px;
        background-color: white;
        border:1px solid #ccc;
        -moz-box-shadow:#555 2px 2px 8px;
        -webkit-box-shadow:#555 2px 2px 8px;
        -o-box-shadow:#555 2px 2px 8px;
        box-shadow:#555 2px 2px 8px;
        opacity:0.9;
        filter:alpha(opacity=90);
        font-size:10px;
        font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;
        padding:7px;
    }
    /* sunburst */
    /*TOOLTIPS*/
    #inner-details {
      font-size:12px;
    }

    .tip {
       text-align: left;
       width:auto;
       max-width:500px;
    }

    .tip-title {
      font-size: 11px;
      text-align:center;
      margin-bottom:2px;
    }

    pre {
      background-color:#EEEEEE;
      border:1px solid #CCCCCC;
      font-size:10px;
      margin:5px auto;
      padding:5px;
      width:170px;
      
      white-space: pre-wrap;
      white-space: -moz-pre-wrap;
      white-space: -webkit-pre-wrap;
      white-space: -pre-wrap;
      white-space: -o-pre-wrap;
      word-wrap: break-word;
    }
</style>
<div class="well">
    <legend><strong>交互统计</strong></legend>
    <div>
        <div id="loading_interact" class="alert alert-info">
            系统繁忙计算中，请稍后...
        </div>
        <label>
          <div id="interact_graph_process" class="progress progress-striped active">
            <div id="interact_graph_bar" class="bar" style="width: 100%;"></div>
          </div>
        </label>
    </div>

    <div>
        <p><a class="btn btn-small btn-danger" href="javascript:void(0);" id="out"><i class="icon-picture"></i>导出</a></p>
    </div>

    <div id="community" style="display: none;">
      <div id="center-container" class="container-fluid">
        <div class="row-fluid">
          <div id="infovis" class="span9"></div>
          <div id="inner-details" class="span3"></div>
        </div>
      </div>
    </div>
</div>

<script language="javascript" type="text/javascript" src="/static/js/profile/jit-yc.js"></script>

<script>
  $("a[id='out']").on('click', function (event) {
      download();
      alert("导出成功！");
    });

  function download(){
    var canvas=document.getElementById('infovis-canvas');
    //var ctx=canvas.getContext("2d");
    //var c=document.getElementById('sigma_nodes_1');
    //ctx.drawImage(c,0,0);
    var dataURL=canvas.toDataURL();
    window.open('', '_blank').location.href=dataURL;
  };

  var labelType, useGradients, nativeTextSupport, animate;

  (function() {
    var ua = navigator.userAgent,
        iStuff = ua.match(/iPhone/i) || ua.match(/iPad/i),
        typeOfCanvas = typeof HTMLCanvasElement,
        nativeCanvasSupport = (typeOfCanvas == 'object' || typeOfCanvas == 'function'),
        textSupport = nativeCanvasSupport 
          && (typeof document.createElement('canvas').getContext('2d').fillText == 'function');
    //I'm setting this based on the fact that ExCanvas provides text support for IE
    //and that as of today iPhone/iPad current text support is lame
    labelType = (!nativeCanvasSupport || (textSupport && !iStuff))? 'Native' : 'HTML';
    nativeTextSupport = labelType == 'Native';
    useGradients = nativeCanvasSupport;
    animate = !(iStuff || !nativeCanvasSupport);
  })();

  var Log = {
    elem: false,
    write: function(text){
      if (!this.elem) 
        this.elem = document.getElementById('log');
      this.elem.innerHTML = text;
      this.elem.style.left = (500 - this.elem.offsetWidth / 2) + 'px';
    }
  };

  $(document).ready(function(){
    $.ajax({     
      url:'/profile/person_interact_network/{{uid}}',
      dataType: 'json', 
      success:function(data){
        var status = data['status'];
        var data = data['data'];
        if (status == 'finished') {
              $("#interact_graph_bar").css('width', "100%")
              $("#interact_graph_process").removeClass("active");
              $("#interact_graph_process").removeClass("progress-striped");
              if(data){
                $("#loading_interact").text("计算完成!");
                $("#community").css("display", "block");
                init(data);
              }else{
                $("#loading_interact").text("很抱歉，计算结果为空!");
              }
        }else{
          return
        }  
      }
    })
  })

  function init(data){
      //init data
      var json = data;
      console.log(json);
      var sb = new $jit.Sunburst({
          //id container for the visualization
          injectInto: 'infovis',
          //Distance between levels
          levelDistance: 75,
          //Change node and edge styles such as
          //color, width and dimensions.
          Node: {
            overridable: true,
            type: useGradients? 'gradient-multipie' : 'multipie'
          },
          //Select canvas labels
          //'HTML', 'SVG' and 'Native' are possible options
          Label: {
            type: labelType
          },
          //Change styles when hovering and clicking nodes
          NodeStyles: {
            enable: true,
            type: 'Native',
            stylesClick: {
              'color': '#33dddd'
            },
            stylesHover: {
              'color': '#dd3333'
            }
          },
          //Add tooltips
          Tips: {
            enable: true,
            onShow: function(tip, node) {
              var html = ""; 
              var data = node.data;
              if("profileImageUrl" in data) {
                html += "<li><img style=\"width: 50px; height: 50px;\" src= "+data.profileImageUrl+" ></li>";
              }
              if ("name" in node) {
                html+="<br /><b>昵称:</b> " + node.name;

              }
              if("count"in data){
                html+="<br/><b>交互次数:</b>"+data.count;
              }
              if("friendsCount" in data) {
                html += "<br /><b>关注数:</b> " + data.friendsCount;
              }
              if("followersCount" in data) {
                html += "<br /><b>粉丝数:</b> " + data.followersCount;
              }
              if("statusesCount" in data) {
                html += "<br /><b>微博数:</b> " + data.statusesCount;
              }
              if("gender" in data) {
                if (data.gender=='m'){
                     var g='男'
                  }
                else{
                     var g ='女'
                  }
                html += "<br /><b>性别:</b> " + g;
              }
              if("verified" in data) {
                if (data.verified){
                     var g='是'
                  }
                else{
                     var g ='否'
                  }
                html += "<br /> <b>认证用户:</b>"+g;
              }
              if("id" in data) {
                html += "<br /> <b>用户id:</b> "+ data.id;
              }

              tip.innerHTML = html;
            }
          },
          //implement event handlers
          Events: {
            enable: true,
            onClick: function(node) {
              if(!node) return;
              //Build detailed information about the file/folder
              //and place it in the right column.
              var html = ""; 
              var data = node.data;
              if("profileImageUrl" in data) {
                html += "<li><img style=\"width: 50px; height: 50px;\" src= "+data.profileImageUrl+" ></li>";
              }
              if ("name" in node) {
                html+="<br/><b>昵称:</b> " + node.name;

              }
              if("count"in data){
                html+="<br/><b>交互次数:</b>"+data.count;
              }
              if("friendsCount" in data) {
                html += "<br /><b>关注数:</b> " + data.friendsCount;
              }
              if("followersCount" in data) {
                html += "<br /><b>粉丝数:</b> " + data.followersCount;
              }
              if("statusesCount" in data) {
                html += "<br /><b>微博数:</b> " + data.statusesCount;
              }
              if("gender" in data) {
                if (data.gender=='m'){
                     var g='男'
                  }
                else{
                     var g ='女'
                  }
                html += "<br /><b>性别:</b> " + g;
              }
              if("verified" in data) {
                if (data.verified){
                     var g='是'
                  }
                else{
                     var g ='否'
                  }
                html += "<br /> <b>认证用户：</b>"+g;
              }
              if("id" in data) {
                html += "<br /> <b>用户id:</b> "+ data.id;
              }
              
              $jit.id('inner-details').innerHTML = html;
              //hide tip
              sb.tips.hide();
              //rotate
              sb.rotate(node, animate? 'animate' : 'replot', {
                duration: 1000,
                transition: $jit.Trans.Quart.easeInOut
              });
            }
          },
          // Only used when Label type is 'HTML' or 'SVG'
          // Add text to the labels. 
          // This method is only triggered on label creation
          onCreateLabel: function(domElement, node){
            var labels = sb.config.Label.type,
                aw = node.getData('angularWidth');
            if (labels === 'HTML' && (node._depth < 2 || aw > 2000)) {
              domElement.innerHTML = node.name;
            } else if (labels === 'SVG' && (node._depth < 2 || aw > 2000)) {
              domElement.firstChild.appendChild(document.createTextNode(node.name));
            }
          },
          // Only used when Label type is 'HTML' or 'SVG'
          // Change node styles when labels are placed
          // or moved.
          onPlaceLabel: function(domElement, node){
            var labels = sb.config.Label.type;
            if (labels === 'SVG') {
              var fch = domElement.firstChild;
              var style = fch.style;
              style.display = '';
              style.cursor = 'pointer';
              style.fontSize = "0.8em";
              fch.setAttribute('fill', "#fff");
            } else if (labels === 'HTML') {
              var style = domElement.style;
              style.display = '';
              style.cursor = 'pointer';
              style.fontSize = "0.8em";
              style.color = "#ddd";
              var left = parseInt(style.left);
              var w = domElement.offsetWidth;
              style.left = (left - w / 2) + 'px';
            }
          }
     });
      //load JSON data.
      sb.loadJSON(json);
      //compute positions and plot.
      sb.refresh();
      //end
  }
</script>
{% endblock body %}

