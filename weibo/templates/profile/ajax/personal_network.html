{% extends 'profile/ajax/ajax_layout.html' %}

{% block body %}

<div class="well">
    <legend><strong>关注者统计</strong></legend>
    <div>
        <div id="loading_interact_statistics" class="alert alert-info">
            系统繁忙计算中，请稍后...
        </div>
        <label>
          <div id="interact_process" class="progress progress-striped active">
            <div id="interact_bar" class="bar" style="width: 100%;"></div>
          </div>
        </label>
    </div>
    <div class="container-fluid">
      <div class="row-fluid">
        <div id="direct_interact_count_container" class="span5" style="width: 400px; height: 250px; margin: 0 5px 0 auto; display: none;"></div>
        <div id="retweet_interact_count_container" class="span5" style="width: 400px; height: 250px; margin: 0 5px 0 auto; display: none;"></div>
      </div>
      <br>
      <div class="row-fluid">
        <div id="retweet_friends_interact_count_container" class="span5" style="width: 400px; height: 250px; margin: 0 5px 0 auto; display: none;"></div>
        <div id="fields_dist_container" class="span5" style="width: 400px; height: 250px; margin: 0 auto; display: none;"></div>
      </div>
    </div>
</div>
<div class="well">
    <legend><strong>关注者交互排序</strong></legend>
    <div>
        <div id="loading_interact_rank" class="alert alert-info">
            系统繁忙计算中，请稍后...
        </div>
        <label>
          <div id="interact_rank_process" class="progress progress-striped active">
            <div id="interact_rank_bar" class="bar" style="width: 100%;"></div>
          </div>
        </label>
    </div>

    <div>
        <p><a class="btn btn-small btn-success" href="#" id="out"><i class="icon-download-alt"></i>导出</a></p>
    </div>

    <div id="friends_rank_table"><table class="table table-bordered"></table></div>

    <div id="friends_rank_page_selection" class="pagination-centered"></div>

</div>
  
<script src="/static/js/admin/jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/static/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<script src="/static/js/jquery.bootpag.js"></script>
<script>
    var len = $('script').filter(function () {
      return ($(this).attr('src') == '/static/js/profile/highcharts.js');
    }).length;

    if(len == 0){
      loadScript('/static/js/profile/highcharts.js');
      loadScript('/static/js/profile/exporting.js');
    }

    function loadScript(scriptLocationAndName) {
      var head = document.getElementsByTagName('head')[0];
      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = scriptLocationAndName;
      head.appendChild(script);
    }

	function display_interact_chart(retweeted_uid_data, retweeted_friends_data, direct_uid_data) {
		var direct_uid_list = [];
    var retweeted_uid_list = [];
    var retweeted_friends_list = [];

		for(var i in retweeted_uid_data){
			retweeted_uid_list.push([retweeted_uid_data[i][0].toString(), retweeted_uid_data[i][1]]);
		}
    for(var i in retweeted_friends_data){
      retweeted_friends_list.push([retweeted_friends_data[i][0].toString(), retweeted_friends_data[i][1]]);
    }
    for(var i in direct_uid_data){
      direct_uid_list.push([direct_uid_data[i][0], direct_uid_data[i][1]]);
    }
    var chart = new Highcharts.Chart({
        chart: {
            renderTo: 'direct_interact_count_container',
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false
        },
        title: {
            text: '直接交互统计'
        },
        tooltip: {
    	    pointFormat: '{series.name}: <b>{point.percentage:.1f} %</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    color: '#000000',
                    connectorColor: '#000000',
                    format: '<b>{point.name}</b>: {point.y}'
                }
            }
        },
        series: [{
            type: 'pie',
            name: '交互占比',
            data: direct_uid_list
        }]
    });
    var chart2 = new Highcharts.Chart({
        chart: {
            renderTo: 'retweet_interact_count_container',
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false
        },
        title: {
            text: '原创交互统计'
        },
        tooltip: {
          pointFormat: '{series.name}: <b>{point.percentage:.1f} %</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    color: '#000000',
                    connectorColor: '#000000',
                    format: '<b>{point.name}</b>: {point.y}'
                }
            }
        },
        series: [{
            type: 'pie',
            name: '交互占比',
            data: retweeted_uid_list
        }]
    });
    var chart2 = new Highcharts.Chart({
        chart: {
            renderTo: 'retweet_friends_interact_count_container',
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false
        },
        title: {
            text: '原创交互统计（关注者）'
        },
        tooltip: {
          pointFormat: '{series.name}: <b>{point.percentage:.1f} %</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    color: '#000000',
                    connectorColor: '#000000',
                    format: '<b>{point.name}</b>: {point.y}'
                }
            }
        },
        series: [{
            type: 'pie',
            name: '交互占比',
            data: retweeted_friends_list
        }]
    });
	}

	function display_fields_chart(data){
		var data_list = [];
		for(var i in data){
			data_list.push([data[i][0], data[i][1]]);
		}
    var chart = new Highcharts.Chart({
        chart: {
            renderTo: 'fields_dist_container',
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false
        },
        title: {
            text: '关注者领域分布'
        },
        tooltip: {
    	    pointFormat: '{series.name}: <b>{point.percentage:.1f} %</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    color: '#000000',
                    connectorColor: '#000000',
                    format: '<b>{point.name}</b>: {point.y}'
                }
            }
        },
        series: [{
            type: 'pie',
            name: '领域占比',
            data: data_list
        }]
    });
	}

	$(document).ready(function(){
		$.ajax({
        url: "/profile/person_network/friends/{{uid}}",
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
          status = data['status'];
          data = data['data'];
          if (status == 'finished') {
              $("#interact_bar").css('width', "100%")
              $("#interact_process").removeClass("active");
              $("#interact_process").removeClass("progress-striped");

              $("#interact_rank_bar").css('width', "100%")
              $("#interact_rank_process").removeClass("active");
              $("#interact_rank_process").removeClass("progress-striped");

              if (data['retweeted_uid'] && data['retweeted_friends'] && data['direct_uid']) {
                  var retweeted_uid_data = data['retweeted_uid'];
                  var retweeted_friends_data = data['retweeted_friends'];
                  var direct_uid_data = data['direct_uid'];
                  var users = data['users'];
                  //$("#fields_dist_container").css("display", "block");
                  if(retweeted_uid_data.length){
                      $("#retweet_interact_count_container").css("display", "block");
                  }
                  if(retweeted_friends_data.length){
                      $("#retweet_friends_interact_count_container").css("display", "block");
                  }
                  if(direct_uid_data.length){
                      $("#direct_interact_count_container").css("display", "block");
                  }
                  if(users.length){
                      $("#loading_interact_rank").text("计算完成!");
                      create_current_table(users, 0, users.length);
                  }
                  else{
                      $("#loading_interact_rank").text("很抱歉，计算结果为空!");
                  }
                  $("#loading_interact_statistics").text("计算完成!");
                  display_interact_chart(retweeted_uid_data, retweeted_friends_data, direct_uid_data);

              }else{
                  $("#loading_interact_statistics").text("很抱歉，计算结果为空!");
                  $("#loading_interact_rank").text("很抱歉，计算结果为空!");
              }
          }
          else
              return
          
        }
    });
    $.ajax({
        url: "/profile/person_fri_fol/friends/{{uid}}?page=1",
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
        	var fields_result = data['fields'];
          display_fields_chart(fields_result);
          //display_fri_fol_table(data);
        }
    });
	});

  function create_current_table(data, start_row, end_row) {
      var cellCount = 8;
      var table = '<table class="table table-bordered">';
      var thead = '<thead><tr><th>排名</th><th>交互次数</th><th style="display:none">博主ID</th><th>博主昵称</th><th>粉丝数</th><th>关注数</th><th>博主地域</th><th>领域</th></tr></thead>';
      //rank, interact, uid, name, followers_count, friends_count, location, domain
      var tbody = '<tbody>';
      for (var i = start_row;i < end_row;i++) {
          var tr = '<tr>';
          if (data[i][6].match("海外")) {
              tr = '<tr class="success">';
          }
          for(var j = 0;j < cellCount;j++) {
              /*
              if (j == 7) {
                  // checkbox
                  var td = '<td><input id="uid_'+ data[i][1] + '" type="checkbox" name="now_user"></td>';
              }
              else if (j == 6) {
                  // identify status
                  if (data[i][j])
                      var td = '<td><i class="icon-ok"></i></td>';
                  else
                      var td = '<td><i class="icon-remove"></i></td>';
              }*/
              if(j == 0) {
                  // rank status
                  var td = '<td><span class="label label-important">'+data[i][j]+'</span></td>';
              }
              else if(j == 2){
                  var td = '<td style="display:none">'+data[i][j]+'</td>';
              }
              else{
                  var td = '<td>'+data[i][j]+'</td>';
              }
              tr += td;
          }
          tr += '</tr>';
          tbody += tr;
      }
      tbody += '</tbody>';
      table += thead + tbody;
      table += '</table>'
      $("#friends_rank_table").html(table);
      /*
      $('#select_all').click(function(){
          var $this = $(this);
          this.checked = !this.checked;
          $.each($('#rank_table :checkbox'), function(i, val) {
              if ($(this) != $this)
                  this.checked = !this.checked;
          });  
      });*/
    }
</script>
{% endblock body %}
