{% extends "moodlens/base.html" %}
{% block title %}主页{% endblock %}
{% block content %}
<head>
<link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='css/datarangepiker.css') }}">
</head>
<body>
<div class="container">
  <div class="well">
    <legend>微博情绪全网分析</legend>
    <div id="all_eomtion" class="inline">
      <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>时间范围:</b></font>
      <div id="reportrange_1" class="btn dropdown-toggle">
      <i class="icon-calendar icon-large"></i>
      <span id="all_time">9月 2,2013 - 9月 4,2013</span> 
	   <b class="caret"></b>
	   </div>
      <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>&nbsp&nbsp&nbsp时间间隔:</b></font>
      <div class="btn dropdown-toggle" style="position:relative;height: 30px;margin-top: 0px;">

        <span style="position:relative;margin-left:100px;width:18px;overflow:hidden;">
        <select name="top_n" style="width:110px;margin-left:-100px;" onchange="this.parentNode.nextSibling.value=this.value">
          <option value="15分钟"> 15分钟 </option>
          <option value="30分钟"> 30分钟 </option>
          <option value="1小时"> 1小时 </option>
          <option value="12小时"> 12小时 </option>
          <option value="1天"> 1天 </option>
          </select></span><input id="dur_time" name="top_n" style="width:75px;position:absolute;left:15px;overflow:hidden;">
      </div>
	   <input type="submit" class="btn btn-primary" value="搜索" id="search_all">
    </div>
  </div>
  
  <div class="well">
    <legend>微博情绪领域分析</legend>
    <div id="field_emotion" class="inline">
      <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>时间范围:</b></font>
     <div id="reportrange_2" class="btn dropdown-toggle">
    <i class="icon-calendar icon-large"></i>
    <span id="field_time">9月 2,2013 - 9月 4,2013</span> 
   <b class="caret"></b>
      </div>
      <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>&nbsp&nbsp&nbsp时间间隔:</b></font>
      <div class="btn dropdown-toggle" style="position:relative;height: 30px;margin-top: 0px;">
        <span style="position:relative;margin-left:100px;width:18px;overflow:hidden;">
          <select name="top_n" style="width:110px;margin-left:-100px" onchange="this.parentNode.nextSibling.value=this.value">
            <option value="15分钟"> 15分钟 </option>
            <option value="30分钟"> 30分钟 </option>
            <option value="1小时"> 1小时 </option>
            <option value="12小时"> 12小时 </option>
            <option value="1天"> 1天 </option>
          </select>
        </span>
        <input id="field_durtime" name="top_n" style="width:75px;position:absolute;left:15px;overflow:hidden;">
      </div>
      <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>&nbsp&nbsp&nbsp领域:</b></font>
      <div class="btn dropdown-toggle" style="position:relative;height: 30px;margin-top: 0px;">
        <span style="position:relative;margin-left:100px;width:18px;overflow:hidden;">
        <select name="top_n" style="width:110px;margin-left:-100px" onchange="this.parentNode.nextSibling.value=this.value">
          <option value="文化"> 文化 </option>
          <option value="教育"> 教育 </option>
          <option value="娱乐"> 娱乐 </option>
          <option value="时尚"> 时尚 </option>
          <option value="财经"> 财经 </option>
          <option value="媒体"> 媒体 </option>
          <option value="体育"> 体育 </option>
          <option value="科技"> 科技 </option>
        </select>
        </span>
        <input id="field_name" name="top_n" style="width:75px;position:absolute;left:15px;overflow:hidden;">
      </div>
      <input type="submit" class="btn btn-primary" value="搜索" id="search_field">
    </div>

  </div>
  
    <div class="well">
    <legend>微博情绪话题分析</legend>
    <div id="topic_emotion" class="inline">
      <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>时间范围:</b></font>
      <div id="reportrange_3" class="btn dropdown-toggle">
    <i class="icon-calendar icon-large"></i>
    <span id="topic_time">9月 2,2013 - 9月 4,2013</span> 
   <b class="caret"></b>
      </div>
      <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>&nbsp&nbsp&nbsp时间间隔:</b></font>
      <div class="btn dropdown-toggle" style="position:relative;height: 30px;margin-top: 0px;">
        <span style="position:relative;margin-left:100px;width:18px;overflow:hidden;">
          <select name="top_n" style="width:110px;margin-left:-100px" onchange="this.parentNode.nextSibling.value=this.value">
            <option value="15分钟"> 15分钟 </option>
            <option value="30分钟"> 30分钟 </option>
            <option value="1小时"> 1小时 </option>
            <option value="12小时"> 12小时 </option>
            <option value="1天"> 1天 </option>
          </select></span><input id="topic_durtime" name="top_n" style="width:75px;position:absolute;left:15px;overflow:hidden;">
      </div>
      <input type="text" id="keyword" name="keyword" value="" placeholder="输入关键词..." style="margin-top: 11px;margin-left: 62px;">
      <input type="hidden" name="action" value="run">
      <input type="submit" class="btn btn-primary" value="搜索" id="search_topic">
    </div>

      <ul id="TopicTab" class="nav nav-tabs">
        <li><a href="#area_1" data-toggle="tab"><strong>系统定制</strong></a></li>
        <li><a href="#TopicTabContent" onclick="add2custom();"><i class="icon-plus"></i></a></li>
        <li><a href="#TopicTabContent" onclick="delcustom();"><i class="icon-minus"></i></a></li>  
        <li><a href="/sysadmin/" target="_blank"><i class="icon-cog"></i></a></li> 
      </ul>
      <div id="alert_topic"></div>
      <div id="TopicTabContent" class="tab-content">
        <div class="tab-pane fade active in" id="area_1">
          <ul class="inline">
          </ul>
        </div>
      </div>
    </div>
      
  </div>
{% endblock %}

{% block script %}
  <script src="{{ url_for('static', filename='js/moodlens/moment.js') }}"></script>
  <script src="{{ url_for('static', filename='js/moodlens/datarangepiker.js') }}"></script>
  <script src="/static/js/bootstrap-alert.js"></script>
  <script type="text/javascript">
    $('#TopicTabContent:checkbox').click(function(){
      var $this = $(this);
      if ($this.is(':checked')) {
          $.each($('#TopicTabContent :checkbox'), function(i, val) {
              if ($(this) != $this) {
                  $(this).attr('checked', false);
              }
          });
          $this.attr('checked', true);
          var topic_str = $this.parent().text().replace(/^\s+|\s+$/g,'');
          $('#keyword').val(topic_str);
      } else {
          $this.attr('checked', false);
          var topic_str = $this.parent().text().replace(/^\s+|\s+$/g,'');
          var current_val = $('#keyword').val();
          current_val = current_val.replace(topic_str, '');
          $('#keyword').val(current_val);
      }
    })

    //all_emotion
    $('#reportrange_1').daterangepicker({
        ranges: {
           '今天': [moment(), moment()],
           '昨天': [moment().subtract('days', 1), moment().subtract('days', 1)],
           '最近7天': [moment().subtract('days', 6), moment()],
           '最近30天': [moment().subtract('days', 29), moment()],
           '本月内': [moment().startOf('month'), moment().endOf('month')],
           '上个月': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
        },
        startDate: moment().subtract('days', 29),
        endDate: moment()
        }, 
        function(start, end) {
          $('#reportrange_1 span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
        }
    );

    //field_emotion
    $('#reportrange_2').daterangepicker({
      ranges: {
         '今天': [moment(), moment()],
         '昨天': [moment().subtract('days', 1), moment().subtract('days', 1)],
         '最近7天': [moment().subtract('days', 6), moment()],
         '最近30天': [moment().subtract('days', 29), moment()],
         '本月内': [moment().startOf('month'), moment().endOf('month')],
         '上个月': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
      },
        startDate: moment().subtract('days', 29),
        endDate: moment()
     }, 
     function(start, end) {
        $('#reportrange_2 span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
     }
    );

    //topic_emotion
    $('#reportrange_3').daterangepicker({
        ranges: {
           '今天': [moment(), moment()],
           '昨天': [moment().subtract('days', 1), moment().subtract('days', 1)],
           '最近7天': [moment().subtract('days', 6), moment()],
           '最近30天': [moment().subtract('days', 29), moment()],
           '本月内': [moment().startOf('month'), moment().endOf('month')],
           '上个月': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
        },
        startDate: moment().subtract('days', 29),
        endDate: moment()
      }, 
      function(start, end) {
        $('#reportrange_3 span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
      }
    );    

    // 动态获取系统定制的话题
    function getCustomizedTopics(){
      $.ajax({
        url: '/moodlens/topics.json',
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
          $('#area_1').empty();
          var html = "<ul class=\"inline\">";
          for(idx in data){
            html += "<li><input type=\"checkbox\" name=\"topics_checkbox\" value=\"" + data[idx] + "\">" + data[idx] + "</li>";
          }
          html += "</ul>";
          $('#area_1').append(html);
        }
      });
    }

    $("#search_all").click(function() {
      var time = $("#all_time").html();
      var during = document.getElementById("dur_time").value;
      console.log(time,during);
      window.location.href="/moodlens/all/?time="+time+"&during="+during;
    });
    $("#search_field").click(function() {
      var time = $("#field_time").html();
      var during = document.getElementById("field_durtime").value;
      var field_name = document.getElementById("field_name").value;
      window.location.href="/moodlens/field/?time="+time+"&during="+during+"&field_name="+field_name;
    });
    $("#search_topic").click(function() {
      var time = $("#topic_time").html();
      var during = document.getElementById("topic_durtime").value;
      var keyword = document.getElementById("keyword").value;
      window.location.href="/moodlens/topic/?time="+time+"&during="+during+"&keyword="+keyword;
    });
    // 动态增加定制话题
    function add2custom(){
      var added_topic = $('#keyword').val();
      if( added_topic == undefined || added_topic == ''){
         var alert_html = "<div class=\"alert\"><button type=\"button\" class=\"close\" data-dismiss=\"alert\">&times;</button><strong>注意!</strong>请从上方文本框中选择您要添加的话题</div>";
         $('#alert_topic').empty();
         $('#alert_topic').append(alert_html);
      }
      else{
        $.ajax({
          url: '/moodlens/topics.json',
          dataType: 'json',
          data: {'operator': 'add', 'topic': added_topic},
          type: "POST",   
          success: function (data) {
            var status = data['status'];
            var item = data['item'];
            getCustomizedTopics();
          }
        });
      }
    }
    
    // 动态删除定制话题
    function delcustom(){
      var del_topic = $("input[name=topics_checkbox]:checked").val();
      if( del_topic == undefined || del_topic == ''){
         var alert_html = "<div class=\"alert\"><button type=\"button\" class=\"close\" data-dismiss=\"alert\">&times;</button><strong>注意!</strong>请从下方选择您删除的话题</div>";
         $('#alert_topic').empty();
         $('#alert_topic').append(alert_html);
      }
      else{
        $.ajax({
          url: '/moodlens/topics.json',
          dataType: 'json',
          data: {'operator': 'del', 'topic': del_topic},
          type: "POST",   
          success: function (data) {
            var status = data['status'];
            var item = data['item'];
            getCustomizedTopics();
          }
        });
      }
    }
    
    $(document).ready(function() {
      getCustomizedTopics();
    });
  </script>
</body>
  
{% endblock %}
