{% extends "propagate/base.html" %}
{% block title %}信息搜索{% endblock title%}
{% block head %}
  <link href="{{ url_for('static', filename='css/propagate/microblog.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/datarangepiker.css') }}" rel="stylesheet">
  <style>
    .WB_feed_datail, .WB_feed_type {
      width: 1000px;
    }
    .WB_info, .WB_text, .WB_detail {
      width: 950px;
    }
  </style>
  <script src="/static/js/admin/jquery-1.9.1.min.js" type="text/javascript"></script>
  

{% endblock head%}
{% block content %}
  <div class="container">
    <div class="row well">
    	<legend><strong>话题信息搜索</strong></legend>
    	<div class="inline">
        <ul>
    	    <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>关键字词:</b></font> <input type="text" class="span2" placeholder="请输入关键字" value="" role="textbox" name="keyword" id="topic_keywords" style="margin-bottom: 0px;">
          <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>&nbsp&nbsp&nbsp时间范围:</b></font>
          <div id="reportrange_topic" class="btn dropdown-toggle">
            <i class="icon-calendar icon-large"></i>
            <span id="topic_time">9月 2,2013 - 9月 4,2013</span>
            <b class="caret"></b>
          </div>
          <input type="hidden" name="r" value="1">
          &nbsp&nbsp&nbsp
          <input type="submit" class="btn btn-primary" value = "搜索" onclick="find_search_message()" id="search_topic">
        </ul>
    	</div>
    <div id="show_search_msg"></div>
    <div id="search_on" class="inline">
      <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>可查看任务:</b></font>
    </div>
    <div id="show_history_msg" class="well"></div>
    <div id="search_now" class="inline">
      <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>正在进行中任务:</b></font>
    </div>
    <div id="show_history_now" class="well"></div>
    </div>
	  <div class="row well">
      <legend><strong>微博信息搜索</strong></legend>
      <div class="inline">
        <ul id="TypeTab" class="nav nav-tabs">
          <li class="active"><a href="#weibomid" data-toggle="tab">微博MID</a></li>
          <li><a href="#weibourl" data-toggle="tab">微博URL</a></li>
        </ul>
        
      </div> 
      <div id="LocationTabContent" class="tab-content">
        <div class="tab-pane fade active in" id="weibomid">
          <ul>
            <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>微博MID:</b></font>
            <input type="text" class="span2" placeholder="请输入微博ID" value="" role="textbox" name="weibo_mid" id="weibo_mid" style="margin-bottom: 0px;">
            <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>&nbsp&nbsp&nbsp时间范围:</b></font>
            <div id="reportrange_singlebyid" class="btn dropdown-toggle">
              <i class="icon-calendar icon-large"></i>
              <span id="weibo_time_id">{% if time_str %}{{time_str}}{% else %}9月 1,2013 - 9月 3,2013{% endif %}</span> 
              <b class="caret"></b>
            </div>
            <input type="hidden" name="r" value="1">
            &nbsp&nbsp&nbsp
            <input type="submit" class="btn btn-primary" value = "搜索" onclick="find_search_message_id()" id="search_weibobyid">
          </ul>
        </div>
        <div class="tab-pane fade" id="weibourl">
          <ul>
            <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>微博URL:</b></font>
            <input type="text" class="span2" placeholder="请输入微博URL" value="" role="textbox" name="weibo_url" id="weibo_url" style="margin-bottom: 0px;">
            <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>&nbsp&nbsp&nbsp时间范围:</b></font>
            <div id="reportrange_singlebyurl" class="btn dropdown-toggle">
              <i class="icon-calendar icon-large"></i>
              <span id="weibo_time_url">9月 1,2013 - 9月 3,2013</span> 
              <b class="caret"></b>
            </div>
            <input type="hidden" name="r" value="1">
            &nbsp&nbsp&nbsp
            <input type="submit" class="btn btn-primary" value = "搜索" onclick="find_search_message_url()" id="search_weibobyurl">
          </ul>
        </div>
        
      </div>
      <div id="show_search_msg_single"></div>
    <div id="search_on" class="inline">
      <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>可查看任务:</b></font>
    </div>
    <div id="show_history_msg_single" class="well"></div>
    <div id="search_now" class="inline">
      <font color="#003366" face="Georgia, Times New Roman, Times, serif"><b>正在进行中任务:</b></font>
    </div>
    <div id="show_history_now_single" class="well"></div>
    </div>
  </div> <!-- /container -->
{% endblock %}
{% block script %}
  <script src="{{ url_for('static', filename='js/identify/topic_selector.js') }}"></script>
  <script src="/static/js/identify/datarangepiker.js" type="text/javascript"></script>
  <script src="/static/js/identify/moment.js" type="text/javascript"></script>
   <script type="text/javascript">
    $(document).ready(function() {
      var mid='{{mid}}';
      if(mid){
        document.getElementById('weibo_mid').value=mid;
      }
  $('#reportrange_topic').daterangepicker({
      ranges: {
         '今天': [moment(), moment()],
         '昨天': [moment().subtract('days', 1), moment().subtract('days', 1)],
         '最近7天': [moment().subtract('days', 6), moment()],
         '最近30天': [moment().subtract('days', 29), moment()],
         '本月内': [moment().startOf('month'), moment().endOf('month')],
         '上个月': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
      },
      startDate: moment().subtract('days', 29),
      endDate: moment()
    }, 
    function(start, end) {
  $('#reportrange_topic span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
    }
  );
  $('#reportrange_singlebyid').daterangepicker({
      ranges: {
         '今天': [moment(), moment()],
         '昨天': [moment().subtract('days', 1), moment().subtract('days', 1)],
         '最近7天': [moment().subtract('days', 6), moment()],
         '最近30天': [moment().subtract('days', 29), moment()],
         '本月内': [moment().startOf('month'), moment().endOf('month')],
         '上个月': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
      },
      startDate: moment().subtract('days', 29),
      endDate: moment()
    }, 
    function(start, end) {
  $('#reportrange_singlebyid span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
    }
  );
    $('#reportrange_singlebyurl').daterangepicker({
      ranges: {
         '今天': [moment(), moment()],
         '昨天': [moment().subtract('days', 1), moment().subtract('days', 1)],
         '最近7天': [moment().subtract('days', 6), moment()],
         '最近30天': [moment().subtract('days', 29), moment()],
         '本月内': [moment().startOf('month'), moment().endOf('month')],
         '上个月': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
      },
      startDate: moment().subtract('days', 29),
      endDate: moment()
    }, 
    function(start, end) {
  $('#reportrange_singlebyurl span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
    }
  );
});


function get_and_show_history_msg(){
      $.ajax({
        url: '/propagate/history.json?now=1',
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
          $('#show_history_msg').empty();
          var html = "";
          for(idx in data){
            html += "<li><a target='_blank' href=\"/propagate/topic_ajax_weibos/?keyword=" + data[idx][0] + "&time=" + data[idx][1] + "\">" + data[idx] + "</a></li>";
          }
          $('#show_history_msg').append(html);
        }
      });
    }

    function get_and_show_history_now(){
      var temp_time_in13 = new Date().getTime();
      var timestamp = temp_time_in13.toString().substr(0, 10);
      $.ajax({
        url: '/propagate/history.json?now1=-1&now2=0&timestamp=' + timestamp,
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
          $('#show_history_now').empty();
          var html = "";
          for(idx in data){
            html += "<li>" + data[idx] + "</li>";
          }
          $('#show_history_now').append(html);
        }
      });
    }

    function max_history_limit(){
      var max = 0;
      var time = $("#topic_time").html();
      var keyword = document.getElementById("topic_keywords").value;
      var temp_time_in13 = new Date().getTime();
      var timestamp = temp_time_in13.toString().substr(0, 10);
      var search_msg = "请从上方文本框中输入话题"
      $.ajax({
        url: '/propagate/history.json?now2=0&now1=-1',
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
          for(idx in data){
            max += 1;
          }
          if (max > 5){
            var search_html = "<div class=\"well\"><font color=\"#FF0033\" face=\"Georgia, Times New Roman, Times, serif\"><b>正在计算中任务已经达到10条的限制，提交失败，请稍后提交！！</b></font></div>"
            $('#show_search_msg').empty();
            $('#show_search_msg').append(search_html);
            $('#search_topic').val('搜索');
          }
          else{
            if(keyword.length < 2)
              var search_html = "<div class=\"well\"><li>" + search_msg + "</li></div>";
            else{
              $('#search_topic').val('搜索');
              $('#show_search_msg').empty();
              $.ajax({
                url: '/propagate/topic/submit?keyword=' + keyword + "&time="+ time + "&timestamp=" + timestamp,
                dataType: 'json',   
                type: "GET",   
                success: function (data) {
                  check_status();
                }
              });
              get_and_show_history_now();
            }
          }
        }
      });
    }

    function find_history(){
      $('#show_search_msg').empty();
      var keyword = document.getElementById("topic_keywords").value;
      $.ajax({
        url: '/propagate/history.json?keyword=' + keyword,
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
          $('#show_search_msg').empty();
          var html = "<div  class=\"inline\"><font color=\"#003366\" face=\"Georgia, Times New Roman, Times, serif\"><b>您的历史记录相关选项:</b></font></div><div  class=\"well\">";
          if(data.length > 0){
            for(idx in data){
              html += "<li><a target='_blank' href=\"/propagate/topic_ajax_weibos/?keyword=" + data[idx][0] + "&time=" + data[idx][1] + "\">" + data[idx] + "</a></li>";
            }
            html = html + "</div>";
          }
          else{
            html = html + "无匹配项！</div>";
          }
          $('#show_search_msg').append(html);
        }
      });
    }
  
    function find_search_message(){
      var command = $('#search_topic').val();
      if (command == '搜索'){
        var keyword = document.getElementById("topic_keywords").value;
        if(keyword.length < 2){
          var search_msg = "请从上方文本框中输入话题"
          var search_html = "<div class=\"well\"><li>" + search_msg + "</li></div>";
          $('#show_search_msg').empty();
          $('#show_search_msg').append(search_html);
        }
        else{
          find_history();
          $('#search_topic').val('确认提交');
        }
      }else if (command == '确认提交'){
        max_history_limit();
        
    }
  }
    function check_status(){
      get_and_show_history_msg();
      get_and_show_history_now();
      get_and_show_history_msg_single();
      get_and_show_history_now_single();
    }  

    function get_and_show_history_msg_single(){
      $.ajax({
        url: '/propagate/history_id.json?now=1',
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
          $('#show_history_msg_single').empty();
          var html = "";
          for(idx in data){
            html += "<li><a target='_blank' href=\"/propagate/single_ajax_weibos/?mid=" + data[idx][0] + "&time=" + data[idx][1] + "\">" + data[idx] + "</a></li>";
          }
          $('#show_history_msg_single').append(html);
        }
      });
    }
    function get_and_show_history_now_single(){
      var temp_time_in13 = new Date().getTime();
      var timestamp = temp_time_in13.toString().substr(0, 10);
      $.ajax({
        url: '/propagate/history_id.json?now1=-1&now2=0&timestamp=' + timestamp,
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
          $('#show_history_now_single').empty();
          var html = "";
          for(idx in data){
            html += "<li>" + data[idx] + "</li>";
          }
          $('#show_history_now_single').append(html);
        }
      });
    }

    function max_history_limit_single(mid,flag){
      var max = 0;
      if(flag == 0){
        var time = $("#weibo_time_id").html();
        var search_msg = "请从上方文本框中输入微博id";
      }
      else{
        var time = $("#weibo_time_url").html();
        var search_msg = "请从上方文本框中输入微博url";
      }
      var mid = mid;
      var temp_time_in13 = new Date().getTime();
      var timestamp = temp_time_in13.toString().substr(0, 10);      
      $.ajax({
        url: '/propagate/history_id.json?now2=0&now1=-1',
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
          for(idx in data){
            max += 1;
          }
          if (max > 5){
            var search_html = "<div class=\"well\"><font color=\"#FF0033\" face=\"Georgia, Times New Roman, Times, serif\"><b>正在计算中任务已经达到10条的限制，提交失败，请稍后提交！！</b></font></div>"
            $('#show_search_msg_single').empty();
            $('#show_search_msg_single').append(search_html);
            if(flag == 0){
              $('#search_weibobyid').val('搜索');
            }
            else{
              $('#search_weibobyurl').val('搜索');
            }
          }
          else{
            if(mid.length < 2){
              var search_html = "<div class=\"well\"><li>" + search_msg + "</li></div>";
              $('#show_search_msg_single').empty();
              $('#show_search_msg_single').append(search_html);
            }
              
            else{
              if(flag == 0){
                $('#search_weibobyid').val('搜索');
              }
              else{
                $('#search_weibobyurl').val('搜索');
              }
              $('#show_search_msg_single').empty();
              $.ajax({
                url: '/propagate/weibo/submit?mid=' + mid + "&time="+ time + "&timestamp=" + timestamp,
                dataType: 'json',   
                type: "GET",   
                success: function (data) {
                  if(data=='wrong'){
                    var search_html = "<div class=\"well\"><li>您输入的时间范围有误</li></div>";
                    $('#show_search_msg_single').empty();
                    $('#show_search_msg_single').append(search_html);
                  }
                  else{
                    check_status();
                  }
                  
                }
              });
              get_and_show_history_now_single();
            }
          }
        }
      });
    }

    function find_history_single(mid){
      $('#show_search_msg_single').empty();
      $.ajax({
        url: '/propagate/history_id.json?mid=' + mid,
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
          $('#show_search_msg_single').empty();
          var html = "<div  class=\"inline\"><font color=\"#003366\" face=\"Georgia, Times New Roman, Times, serif\"><b>您的历史记录相关选项:</b></font></div><div  class=\"well\">";
          if(data.length > 0){
            for(idx in data){
              html += "<li><a target='_blank' href=\"/propagate/single_ajax_weibos/?mid=" + data[idx][0] + "&time=" + data[idx][1] + "\">" + data[idx] + "</a></li>";
            }
            html = html + "</div>";
          }
          else{
            html = html + "无匹配项！</div>";
          }
          $('#show_search_msg_single').append(html);
        }
      });
    }
  
    function find_search_message_id(){
      var command = $('#search_weibobyid').val();
      var mid = document.getElementById("weibo_mid").value;
      if (command == '搜索'){        
        if(mid.length < 2){
          var search_msg = "请从上方文本框中输入微博id"
          var search_html = "<div class=\"well\"><li>" + search_msg + "</li></div>";
          $('#show_search_msg_single').empty();
          $('#show_search_msg_single').append(search_html);
        }
        else{
          find_history_single(mid);
          $('#search_weibobyid').val('确认提交');
        }
      }else if (command == '确认提交'){
        max_history_limit_single(mid,0);
        
    }
  }  
    function find_search_message_url(){
      var command = $('#search_weibobyurl').val();
      var url = document.getElementById("weibo_url").value;
      if (command == '搜索'){        
        if(url.length < 2){
          var search_msg = "请从上方文本框中输入微博url"
          var search_html = "<div class=\"well\"><li>" + search_msg + "</li></div>";
          $('#show_search_msg_single').empty();
          $('#show_search_msg_single').append(search_html);
        }
        else{
          $.ajax({
            url: '/propagate/url2mid?url=' + url,
            dataType: 'json',   
            type: "POST",   
            success: function (data) {
              if(data == 'Wrong'){
                var search_msg = "您输入的微博url有误"
                var search_html = "<div class=\"well\"><li>" + search_msg + "</li></div>";
                $('#show_search_msg_single').empty();
                $('#show_search_msg_single').append(search_html);
              }
              else{
                var mid = data;
                find_history_single(mid);
                $('#search_weibobyurl').val('确认提交');
              }              
            }
          });
          
        }
      }else if (command == '确认提交'){
        $.ajax({
            url: '/propagate/url2mid?url=' + url,
            dataType: 'json',   
            type: "POST",   
            success: function (data) {
              if(data == 'Wrong'){
                var search_msg = "您输入的微博url有误"
                var search_html = "<div class=\"well\"><li>" + search_msg + "</li></div>";
                $('#show_search_msg_single').empty();
                $('#show_search_msg_single').append(search_html);
              }
              else{
                var mid = data;
                max_history_limit_single(mid,1);
              }              
            }
          });                
    }
  } 

    $(document).ready(function() {
      get_and_show_history_msg();
      get_and_show_history_now();
      get_and_show_history_msg_single();
      get_and_show_history_now_single();
      setInterval("check_status()", 10000);
    });
</script>
{% endblock %}
