{% extends "master.html" %}
{% block title %}网民情绪监测和预警{% endblock %}
{% block head %}
<link rel="stylesheet" href="/static/css/toggle_switch.css">
<style>
    .title {
        margin: 30px auto;
        font-size: 30px;
        font-weight: 200;
        line-height: 1;
        letter-spacing: -1px;
        text-align: center;
    }
    #presets a.first {
        border-left: none;
    }
    #presets a {
        border-left: solid #666 1px;
        padding: 0 10px;
    }
    a.active {
        text-decoration: none;
        color: #000;
        font-weight: bold;
        cursor: text;
    }
    #emotion_chart_div {
        height:400px;
        border:1px solid gray;
        margin-left:auto;
        margin-right:auto
    }
    #tag_cloud_div {
        height:200px;
        margin-left:auto;
        margin-right:auto
    }
    #emotion_pie_container{
        height: 200px;
        float: left;
    }
    #weibo_container{
        width: 340px;
        float: left;
    }
    .icon-up {
        filter: alpha(opacity=50);
        opacity: 0.5;
        -moz-opacity: 0.5;
    }
    .goog-custom-button .icon-up, .goog-custom-button .icon-down {
        display: block;
    }
    .icon-up {
        background: url("/static/img/ui.png") no-repeat;
        width: 14px;
        height: 14px;
        padding: 0;
        margin: 0;
        position: relative;
    }
    #scrollingListTd {
        padding-left: 2px;
    }
    .chartclient-annotation, .chartclient-annotation-sel {
        margin: 0;
        padding: 0 0 1px 0;
        cursor: pointer;
    }
    .chartclient-annotation-table {
        padding: 0;
        margin: 0;
        border: 0;
        font-size: 9pt;
    }
    .chartclient-annotation-cell-1, .chartclient-annotation-cell-2 {
        vertical-align: top;
        margin: 0;
        padding-top: 1px;
    }
    .chartclient-annotation-letter {
        text-decoration: none;
        padding: 0 1px 0 1px;
        color: #111;
        font-weight: bold;
        background: url("/static/img/ui.png") repeat-x 0 -40px;
        border: 1px solid #aaa;
    }
    .chartclient-annotation-letter {
        display: inline;
        margin: 0px 5px 0px 0px;
        font-weight: bold;
        text-decoration: underline;
        color: #00C;
        cursor: pointer;
    }
    .chartclient-annotation-title {
        display: inline;
        margin: 0px 5px 0px 0px;
        font-weight: bold;
    }
    .chartclient-annotation-content {
        white-space: normal;
    }
    .chartclient-annotation-content {
        display: inline;
        color: #666;
    }
    .chartclient-annotation-date {
        font-size: 0.9em;
        color: #BBB;
        display: block;
    }
    #togglecount{
        width: 200px;
        position: absolute;
        top: 147px;
        left: 90px;
        z-index: 1000;
    }
</style>
{% endblock %}
{% block content %}
    <div class="container-fluid">
        <div class="row-fluid">
            <div style="text-align: center">
                <div id="presets">
                    <a class="first" href="/moodlens/">全网</a>
                    <a class="active" href="/moodlens/field">领域</a>
                    <a class="" href="/moodlens/topic">话题</a>
                </div>
                <div style="font-size: 15px;">
                    <a href="#"><span class="label label-info"> 文化 </span></a>
                    <a href="#"><span class="label label-info"> 教育 </span></a>
                    <a href="#"><span class="label label-info"> 娱乐 </span></a>
                    <a href="#"><span class="label label-info"> 时尚 </span></a>
                    <a href="#"><span class="label label-info"> 财经 </span></a>
                    <a href="#"><span class="label label-info"> 媒体 </span></a>
                    <a href="#"><span class="label label-info"> 体育 </span></a>
                    <a href="#"><span class="label label-info"> 科技 </span></a>                    
                </div>
            </div>
            <hr class="soften">
        </div>
        <div id="emotion_chart_div" class="row-fluid">
            <div class="span8">
                <div class="control-group" id="togglecount">
                    <div class="controls btn switch switch-two">
                        <input id="absolute" name="view" type="radio">
                        <label for="absolute" onclick="switch2('absolute');">绝对数量</label>

                        <input id="relative" name="view" type="radio" checked>    
                        <label for="relative" onclick="switch2('relative');">相对比例</label>                       
                        <span class="slide-button btn btn-success"></span>
                    </div>
                </div>
                <div id="emotion_container" style="width:900px;"></div>
            </div>
            <div id="weibo_container" class="span4">
                <table border="0" cellspacing="0" cellpadding="0" width="100%">
                    <tbody>
                        <tr>
                            <td id="scrollingListTd" style="width: 100%;">
                                <div style="overflow: hidden; position: relative; width: 100%; height: 400px;">
                                    <div style="position: relative; left: 0px; top: 0px;" id="weibos">
                                        <div class="chartclient-annotation"><table border="0" cellspacing="0" cellpadding="0" class="chartclient-annotation-table"><tbody><tr><td class="chartclient-annotation-cell-1"><div class="chartclient-annotation-letter">A1.</div></td><td class="chartclient-annotation-cell-2"><div class="chartclient-annotation-title">happy Event </div><div class="chartclient-annotation-content">转发微博</div><div class="chartclient-annotation-date">2013-02-27 01:44:05</div></td></tr></tbody></table></div>
                                        <div class="chartclient-annotation"><table border="0" cellspacing="0" cellpadding="0" class="chartclient-annotation-table"><tbody><tr><td class="chartclient-annotation-cell-1"><div class="chartclient-annotation-letter">A2.</div></td><td class="chartclient-annotation-cell-2"><div class="chartclient-annotation-title">happy Event </div><div class="chartclient-annotation-content">转发微博</div><div class="chartclient-annotation-date">2013-02-27 01:35:22</div></td></tr></tbody></table></div>
                                        <div class="chartclient-annotation"><table border="0" cellspacing="0" cellpadding="0" class="chartclient-annotation-table"><tbody><tr><td class="chartclient-annotation-cell-1"><div class="chartclient-annotation-letter">A3.</div></td><td class="chartclient-annotation-cell-2"><div class="chartclient-annotation-title">happy Event </div><div class="chartclient-annotation-content">转发微博</div><div class="chartclient-annotation-date">2013-02-27 01:29:02</div></td></tr></tbody></table></div>
                                        <div class="chartclient-annotation"><table border="0" cellspacing="0" cellpadding="0" class="chartclient-annotation-table"><tbody><tr><td class="chartclient-annotation-cell-1"><div class="chartclient-annotation-letter">A4.</div></td><td class="chartclient-annotation-cell-2"><div class="chartclient-annotation-title">happy Event </div><div class="chartclient-annotation-content">//@凯迪拉克: 备受市场关注和期待的凯迪拉克全新豪华轿车XTS在广州隆重上市发布，售价34.99万元~56.99万元。</div><div class="chartclient-annotation-date">2013-02-27 01:16:35</div></td></tr></tbody></table></div>
                                        <div class="chartclient-annotation"><table border="0" cellspacing="0" cellpadding="0" class="chartclient-annotation-table"><tbody><tr><td class="chartclient-annotation-cell-1"><div class="chartclient-annotation-letter">A5.</div></td><td class="chartclient-annotation-cell-2"><div class="chartclient-annotation-title">happy Event </div><div class="chartclient-annotation-content">转发微博</div><div class="chartclient-annotation-date">2013-02-27 01:25:42</div></td></tr></tbody></table></div>
                                        <div class="chartclient-annotation"><table border="0" cellspacing="0" cellpadding="0" class="chartclient-annotation-table"><tbody><tr><td class="chartclient-annotation-cell-1"><div class="chartclient-annotation-letter">B1.</div></td><td class="chartclient-annotation-cell-2"><div class="chartclient-annotation-title">happy Event </div><div class="chartclient-annotation-content">ZB妈妈自家制的鱼皮饺无敌好吃！这面，也无敌好吃...饿死我拉〜[晕][晕][晕]</div><div class="chartclient-annotation-date">2013-03-09 01:02:22</div></td></tr></tbody></table></div>
                                        <div class="chartclient-annotation"><table border="0" cellspacing="0" cellpadding="0" class="chartclient-annotation-table"><tbody><tr><td class="chartclient-annotation-cell-1"><div class="chartclient-annotation-letter">B2.</div></td><td class="chartclient-annotation-cell-2"><div class="chartclient-annotation-title">happy Event </div><div class="chartclient-annotation-content">"有滋有味女人节"，这个活动推荐给大家，点击http://t.cn/zYEuLQi 进入 地址：http://t.cn/zYEuLQi</div><div class="chartclient-annotation-date">2013-03-09 01:02:21</div></td></tr></tbody></table></div>
                                        <div class="chartclient-annotation"><table border="0" cellspacing="0" cellpadding="0" class="chartclient-annotation-table"><tbody><tr><td class="chartclient-annotation-cell-1"><div class="chartclient-annotation-letter">B3.</div></td><td class="chartclient-annotation-cell-2"><div class="chartclient-annotation-title">happy Event </div><div class="chartclient-annotation-content">低调做人无论在官场、商场还是政治军事斗争中都是一种进可攻、退可守，看似平淡，实则高深的处世谋略。高调做事是一种责任，一种气魄，一种精益求精的风格，一种执著追求的精神。所做的哪怕是细小的事、单调的事，也要代表自己的最高水平，体现自己的最好风格，并在做事中提高素质与能力。</div><div class="chartclient-annotation-date">2013-03-09 01:02:22</div></td></tr></tbody></table></div>
                                        <div class="chartclient-annotation"><table border="0" cellspacing="0" cellpadding="0" class="chartclient-annotation-table"><tbody><tr><td class="chartclient-annotation-cell-1"><div class="chartclient-annotation-letter">B4.</div></td><td class="chartclient-annotation-cell-2"><div class="chartclient-annotation-title">happy Event </div><div class="chartclient-annotation-content">【公共wifi密码，全国通用哦】中国移动：卡号：15821275836 密码：159258；卡号：15800449592 密码：159258；卡号：15800449954 密码：159258；卡号：15800449940 密码：159258。中国电信：但凡你手机能搜到电信chinanet的热点覆盖，全国公免账号07953591377 密码3591377有福同享mark下吧。</div><div class="chartclient-annotation-date">2013-03-09 01:02:22</div></td></tr></tbody></table></div>
                                        <div class="chartclient-annotation"><table border="0" cellspacing="0" cellpadding="0" class="chartclient-annotation-table"><tbody><tr><td class="chartclient-annotation-cell-1"><div class="chartclient-annotation-letter">B5.</div></td><td class="chartclient-annotation-cell-2"><div class="chartclient-annotation-title">happy Event </div><div class="chartclient-annotation-content">烦躁不安心绪不宁，你吗杯啊[抓狂][抓狂][抓狂] 我在:http://t.cn/zYmzepg</div><div class="chartclient-annotation-date">2013-03-09 01:02:21</div></td></tr></tbody></table></div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row-fluid" style="border:1px solid gray;">
            <div id="tag_cloud_div" class="span8">
                <canvas width="900px" height="200px" id="myCanvas">
                    <p>Anything in here will be replaced on browsers that support the canvas element</p>
                </canvas>
                <div id="tags_div">
                    <ul id="tags_ul"><li><a style="font-size:1ex">Tags Cloud</a></li></ul>
                </div>
            </div>
            <div id="emotion_pie_container" class="span4">
            </div>
        </div>
    </div>
    
{% endblock %}
{% block script %}
  <script src="{{ url_for('static', filename='js/highstock.js') }}"></script>
  <script src="{{ url_for('static', filename='js/exporting.js') }}"></script>
  <script src="{{ url_for('static', filename='js/jquery.tagcanvas.min.js') }}"></script>

  <script>
    var oopts = {textHeight: 25,maxSpeed: 0.03,decel: 0.98,depth: 0.92,outlineColour: '#f6f',outlineThickness: 3,pulsateTo: 0.2,pulsateTime: 0.5,wheelZoom: false,textColour:'#00f',shadow:'#ccf',minBrightness:0.2,shadowBlur:3,weight:true,weightMode:'both'};
    
    function redraw_tagcanvas() {
        if(!$('#myCanvas').tagcanvas(oopts,'tags_div')) {
            $('#myCanvas').hide();
        }
    }
    function defscale(count, mincount, maxcount, minsize, maxsize){
      if(maxcount == mincount){
        return (maxsize + minsize) / 2
      }else{
        return minsize + (maxsize - minsize) * Math.pow((count / (maxcount - mincount)), 2)
      }
    }
    var max_word_size = 10;
    var min_word_size = 1;
    function chg_tagcloud(data) {
        $("#tags_ul").empty();
        var cloud_list = [];
        var max_count = 0;
        var min_count = 0;
        for (var i=0;i<data.length;i++) {
            if(max_count < parseInt(data[i][1])){
                max_count = parseInt(data[i][1]);
            }
            if(min_count > parseInt(data[i][1])){
                min_count = parseInt(data[i][1]);
            }
            cloud_list.push([parseInt(data[i][1]), data[i][0]]);
        }
        for (var i=0;i<cloud_list.length;i++) {
            $("#tags_ul").append("<li><a style=\"font-size:"+ defscale(cloud_list[i][0], min_count, max_count, min_word_size, max_word_size) +"ex\">"+ cloud_list[i][1] +"</a></li>");
        }
        redraw_tagcanvas();
    }
    function chg_weibos(data, letter, emotion){
        $("#weibos").empty();
        for(var i=0;i<data.length;i+=1){
            var time = Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', parseInt(data[i]['timestamp']) * 1000);
            var text = data[i]['text'];
            
            var html = "<div class=\"chartclient-annotation\">"; 
            html += "<table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" class=\"chartclient-annotation-table\">";
            html += "<tbody><tr>";
            html += "<td class=\"chartclient-annotation-cell-1\">";
            html += "<div class=\"chartclient-annotation-letter\">" + letter + (i + 1) + ".</div>";
            html += "</td>";
            html += "<td class=\"chartclient-annotation-cell-2\">";
            html += "<div class=\"chartclient-annotation-title\">" + emotion + " Event </div>";
            html += "<div class=\"chartclient-annotation-content\">" + text + "</div>";
            html += "<div class=\"chartclient-annotation-date\">" + time + "</div>";
            html += "</td>";
            html += "</tr>";
            html += "</tbody>";
            html += "</table>";
            html += "</div>";
            $("#weibos").append(html);
        }
    }

    $(document).ready(function(){    
        display_realtime_emotion();
        redraw_tagcanvas();

    })
    var emotion_ratio = {};
    var happy_absolute = [];
    var angry_absolute = [];
    var sad_absolute = []
    var happy_ratio = [];
    var angry_ratio = [];
    var sad_ratio = [];

    function pull_emotion_count(area_type, total_days, times, begin_ts, during, series1, series2, series3, series4, series5, series6){
        if(times >= total_days){
            return;
        }
        
        var ts = begin_ts + times * during;
        $.ajax({
            url: "/moodlens/data/" + area_type + "/" + "?ts=" + ts,
            type: "GET",
            dataType:"json",
            success: function(data){
                var isShift = false;
                var happy_emotion_count = data['happy'][1];
                var angry_emotion_count = data['angry'][1];
                var sad_emotion_count = data['sad'][1];

                var total_emotion_count = happy_emotion_count + angry_emotion_count + sad_emotion_count;
                if(total_emotion_count > 0){
                    var happy_emotion_ratio = parseInt(happy_emotion_count * 100 / total_emotion_count) / 100.0;
                    var angry_emotion_ratio = parseInt(angry_emotion_count * 100 / total_emotion_count) / 100.0;
                    var sad_emotion_ratio = parseInt(sad_emotion_count * 100 / total_emotion_count) / 100.0;
                    series1.addPoint([ts * 1000, happy_emotion_ratio], true, isShift);
                    series2.addPoint([ts * 1000, angry_emotion_ratio], true, isShift);
                    series3.addPoint([ts * 1000, sad_emotion_ratio], true, isShift);
                    emotion_ratio[ts * 1000] = [happy_emotion_ratio, angry_emotion_ratio, sad_emotion_ratio, total_emotion_count];
                    happy_absolute.push([ts * 1000, happy_emotion_count]);
                    angry_absolute.push([ts * 1000, angry_emotion_count]);
                    sad_absolute.push([ts * 1000, sad_emotion_count]);
                    happy_ratio.push([ts * 1000, happy_emotion_ratio]);
                    angry_ratio.push([ts * 1000, angry_emotion_ratio]);
                    sad_ratio.push([ts * 1000, sad_emotion_ratio]);
                }
                else{
                    emotion_ratio[ts * 1000] = [0, 0, 0, 0];
                }
                pull_emotion_flag('happy', 'global', total_days, times, begin_ts, during, series4);
                pull_emotion_flag('angry', 'global', total_days, times, begin_ts, during, series5);
                pull_emotion_flag('sad', 'global', total_days, times, begin_ts, during, series6);
                times++;
                pull_emotion_count(area_type, total_days, times, begin_ts, during, series1, series2, series3, series4, series5, series6);
            }
        });
    }

    function pull_emotion_flag(emotion_type, area_type, total_days, times, begin_ts, during, series){
        if(times >= total_days){
            return;
        }
        var ts = begin_ts + times * during;

        if(emotion_ratio[ts * 1000][3] != 0){
            $.ajax({
                url: '/moodlens/flag_data/' + emotion_type + '/' + area_type + "/" + "?ts=" + ts,
                type: "GET",
                dataType:"json",
                success: function(data){
                    var isShift = false;
                    if(data.length != 0){
                        var d = data[0];
                        var x = d['x'];
                        var title = d['title'];
                        var text = d['text'];
                        var flagClick = function(event){
                            var click_ts = this.x / 1000;
                            $.ajax({
                                url: "/moodlens/keywords_data/happy/global/?ts=" + click_ts,
                                type: "GET",
                                dataType:"json",
                                success: function(data){
                                    chg_tagcloud(data);
                                }
                            });
                            $.ajax({
                                url: "/moodlens/weibos_data/global/?ts=" + click_ts,
                                type: "GET",
                                dataType:"json",
                                success: function(data){
                                    chg_weibos(data, title, emotion_type);
                                }
                            });
                            change_emotion_pie(emotion_ratio[this.x]);     
                        }
                        series.addPoint({'x': x, 'title': title, 'text': text, 'events': {'click': flagClick}}, true, isShift);
                    }
                }
            })
        }
    }

    function change_emotion_pie(raw_data){
        if(raw_data[3] != 0){
            var data = [['高兴', raw_data[0] * 100], ['愤怒', raw_data[1] * 100], ['悲伤', raw_data[2] * 100]];
            $('#emotion_pie_container').empty();
            display_emotion_pie(data);
        }
        
    }

    function display_emotion_pie(data){
        Highcharts.setOptions({
            colors: ['#006600', '#FF0000', '#000099']
        });
        // Build the chart
        $('#emotion_pie_container').highcharts({
            chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false
            },
            title: {
                text: '微博情绪饼图',
            },
            tooltip: {
                pointFormat: '{series.name}: <b>{point.percentage}%</b>',
                percentageDecimals: 1
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: false
                    },
                    showInLegend: true
                }
            },
            series: [{
                type: 'pie',
                name: '微博情绪占比',
                data: data/*[
                    ['高兴',   45.0],
                    ['愤怒',       26.8],
                    {
                        name: '悲伤',
                        y: 12.8,
                        sliced: true,
                        selected: true
                    },
                ]*/
            }]
        });
    }

    function display_realtime_emotion(){
        Highcharts.setOptions({
            global: {
                useUTC: false
            }
        });


        var chart_obj = $('#emotion_container').highcharts({
            chart: {
                type: 'spline',
                animation: Highcharts.svg, // don't animate in old IE
                marginRight: 10,
                events: {
                    load: function() {
                        var total_days = 90;
                        var now_date = new Date();
                        var now_year = now_date.getFullYear();
                        var now_month = now_date.getMonth();
                        var now_day = now_date.getDate();
                        var now_ts = parseInt((new Date(now_year, now_month, now_day)).getTime() / 1000) + 2 * 3600;
                        var during = 24 * 3600;
                        var begin_ts = now_ts - total_days * during;
                        pull_emotion_count('global', total_days, 0, begin_ts, during, this.series[0], this.series[1], this.series[2], this.series[3], this.series[4], this.series[5]);
                    }
                }
            },
            title : {
                text: '微博情绪走势图'
            },

            rangeSelector: {
                selected: 4,
                inputEnabled: false,
                buttons: [{
                    type: 'week',
                    count: 1,
                    text: '1w'
                }, {
                    type: 'month',
                    count: 1,
                    text: '1m'
                }, {
                    type: 'month',
                    count: 3,
                    text: '3m'
                }]
            },
            xAxis: {
                title: {
                    enabled: true,
                    text: '时间'
                },
                type: 'datetime',
                tickPixelInterval: 150
            },
            yAxis: {
                min: 0,
                title: {
                    text: '微 博 条 数'
                },
                plotLines : [{
                    value : 5000,
                    color : 'silver',
                    dashStyle : 'shortdash',
                    width : 2,
                    label : {
                        text : 'low'
                    }
                }, {
                    value : 20000,
                    color : 'red',
                    dashStyle : 'shortdash',
                    width : 2,
                    label : {
                        text : 'high'
                    }
                }]
            },
            tooltip: {
                valueDecimals: 2,
                xDateFormat: '%Y-%m-%d %H:%M'
            },
            legend: {
               layout: 'vertical',
                align: 'right',
                verticalAlign: 'top',
                x: -20,
                y: 0,
                borderWidth: 1,
                enabled: true
            },
            exporting: {
                enabled: true
            },
            series: [{
                name: 'happy',
                data: [],
                id: 'happy',
                color: '#006600',
                marker : {
                    enabled : false,    
                }
            },{
                name: 'angry',
                data: [],
                id: 'angry',
                color: '#FF0000',
                marker : {
                    enabled : false,    
                }
            },{
                name: 'sad',
                data: [],
                id: 'sad',
                color: '#000099',
                marker : {
                    enabled : false,    
                }
            },{
                name: 'happy-events',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'happy',
                shape : 'circlepin',
                width : 16,
                color: '#006600'
            },{
                name: 'angry-events',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'angry',
                shape : 'circlepin',
                width : 16,
                color: '#FF0000'
            },{
                name: 'sad-events',
                type : 'flags',
                data : [],
                cursor: 'pointer',
                onSeries : 'sad',
                shape : 'circlepin',
                width : 16,
                color: '#000099'
            }]
        });
    }

    function switch2(status){
        if(status == 'absolute'){
            var chart = $('#emotion_container').highcharts();
            chart.series[0].update({
                data : happy_absolute
            });
            chart.series[1].update({
                data : angry_absolute
            });
            chart.series[2].update({
                data : sad_absolute
            });
        }
        else{
            var chart = $('#emotion_container').highcharts();
            chart.series[0].update({
                data : happy_ratio
            });
            chart.series[1].update({
                data : angry_ratio
            });
            chart.series[2].update({
                data : sad_ratio
            });
        }
    }
  </script>
{% endblock %}