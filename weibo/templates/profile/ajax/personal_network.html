{% extends 'profile/ajax/ajax_layout.html' %}

{% block body %}
<style>
  .row-fluid [class*="span"]{
    min-height: 34px;
  }
</style>
<form class="form-inline">
    时间范围:
    <select class="span2" name="interval_network" id="nt_interval">
      <option value="270">9个月</option>
      <option value="240">8个月</option>
      <option value="210">7个月</option>
    	<option value="180">6个月</option>
    	<option value="150">5个月</option>
    	<option value="120">4个月</option>
    </select>
    <button type="button" class="btn btn-primary" id="generate_network" onclick="submit_form();return false;"><i class="icon-search"></i>分析</button>
</form>
<div id="interact_count_container" style="width: 450px; height: 250px; margin: 0 auto;float:left;"></div>
<div id="fields_dist_container" style="width: 450px; height: 250px; margin: 0 auto;float:left;"></div>
  <table class="table table-hover">
    <thead>
      <tr>
        <th>ID</th>
        <th>昵称</th>
        <th>微博数</th>
        <th>粉丝数</th>
        <th>关注数</th>
        <th>领域</th>
      </tr>
    </thead>
    <tbody id="user_table">
    </tbody>
  </table>
  <div id="page-selection" class="pagination pagination-centered"></div>
  <script src="/static/js/jquery.bootpag.js"></script>
<script>
  function submit_form(){
    var nt_interval = $('#nt_interval').val();
    $.ajax({
        url: "/profile/person_network/friends/{{uid}}?interval=" + nt_interval,
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
          $('#interact_count_container').empty();
          display_interact_chart(data);
        }
    });
  }
	function display_interact_chart(data){
		var data_list = [];
		for(var i in data){
			data_list.push([data[i][0], data[i][1]]);
		}
		$('#interact_count_container').highcharts({
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false
        },
        title: {
            text: '关注者交互统计'
        },
        tooltip: {
    	    pointFormat: '{series.name}: <b>{point.percentage:.1f} %</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    color: '#000000',
                    connectorColor: '#000000',
                    format: '<b>{point.name}</b>: {point.y}'
                }
            }
        },
        series: [{
            type: 'pie',
            name: '交互占比',
            data: data_list
        }]
    });
	}
	function display_fields_chart(data){
		var data_list = [];
		for(var i in data){
			data_list.push([data[i][0], data[i][1]]);
		}
		$('#fields_dist_container').highcharts({
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false
        },
        title: {
            text: '关注者领域分布'
        },
        tooltip: {
    	    pointFormat: '{series.name}: <b>{point.percentage:.1f} %</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    color: '#000000',
                    connectorColor: '#000000',
                    format: '<b>{point.name}</b>: {point.y}'
                }
            }
        },
        series: [{
            type: 'pie',
            name: '领域占比',
            data: data_list
        }]
    });
	}
	$(document).ready(function(){
    var nt_interval = $('#nt_interval').val();
		$.ajax({
        url: "/profile/person_network/friends/{{uid}}?interval=" + nt_interval,
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
          display_interact_chart(data);
        }
    });
    $.ajax({
        url: "/profile/person_fri_fol/friends/{{uid}}?page=1",
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
        	var fields_result = data['fields'];
          display_fields_chart(fields_result);
          display_fri_fol_table(data);
        }
    });
	});
	function display_fri_fol_table(data){
  	var total_page_number = parseInt(data['pages']);
    var html = "";
    for(var i=0;i < data['users'].length;i += 1){
      user = data['users'][i];
      html += "<tr><td>" + user['id'] + "</td>";
      html += "<td>" + user['userName'] + "</td>";
      html += "<td>" + user['statusesCount'] + "</td>";
      html += "<td>" + user['followersCount'] + "</td>";
      html += "<td>" + user['friendsCount'] + "</td>";
      html += "<td>" + user['field'] + "</td></tr>";
    }
    $("#user_table").append(html);
    $('#page-selection').bootpag({
        total: total_page_number,
        maxVisible: 10
    }).on("page", function(event, /* page number here */ num){
       $("#user_table").empty();
       $.ajax({
          url: "/profile/person_fri_fol/friends/{{uid}}?page=" + num,
          dataType: 'json',   
          type: "GET",
          success: function (data) {
            var html = "";
            for(var i=0;i < data['users'].length;i += 1){
              user = data['users'][i];
              html += "<tr><td>" + user['id'] + "</td>";
              html += "<td>" + user['userName'] + "</td>";
              html += "<td>" + user['statusesCount'] + "</td>";
              html += "<td>" + user['followersCount'] + "</td>";
              html += "<td>" + user['friendsCount'] + "</td>";
              html += "<td>" + user['field'] + "</td></tr>";
            }
            $("#user_table").append(html);
          }
        });
    });
  } 
</script>
{% endblock body %}
