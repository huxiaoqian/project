{% extends "graph/base.html" %}
{% block title %}单条微博传播分析{% endblock %}
{% block head %}
    <meta charset="utf-8">
    <title>锐推图谱</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='ico/favicon.ico')}}">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">
        <meta name="author" content="">
        <link href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}" rel="stylesheet">
        <link href="{{ url_for('static', filename='bootstrap/css/bootstrap-responsive.min.css') }}" rel="stylesheet">
        <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
        <script src="{{ url_for('static', filename='js/jquery.min.js') }}" type="text/javascript"></script>
        <script src="{{ url_for('static', filename='bootstrap/js/bootstrap.min.js') }}" type="text/javascript"></script>
    <style type="text/css">
        /* sigma.js context : */
        .sigma-parent {
            position: relative;
            border-radius: 4px;
            -moz-border-radius: 4px;
            -webkit-border-radius: 4px;
            background: #222;
            height: 740px;
        }
        .sigma-expand {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
    </style>
{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row-fluid">
      <div class="span12">
        <div class="caption" style="float:left">
          <div style="float:left">
            {% if topic_profile_image_url %}
            <img style="width: 150px; height: 140px;" type="image/jpg" src="{{ topic_profile_image_url }}" media="screen" />
            {% else %}
            <img style="width: 150px; height: 140px;" type="image/jpg" src="/static/img/topic_none.png" media="screen" />
            {% endif %}
          </div>
          <div style="float:left;padding-left:50px;">
            <h3>话题传播分析:&nbsp&nbsp&nbsp{{ keyword }}</h3>
            <div style="float:left;padding-top:10px;">
              <label style="font-size:18px">开始时间：<span class="badge badge-success" style="font-size:18px"> {{ return_beg_str }} </span> </label>
              <label class="appendedInput" style="font-size:18px;padding-top:10px;">截止时间：<span class="badge badge-success" style="font-size:18px"> {{ return_end_str }} </span></label>
            </div>
            <div style="float:left;padding-top:10px;padding-left:30px;">
              <label style="font-size:18px">发起人：<span class="badge badge-info" style="font-size:18px"> {{ topic_ori_screen_name }} </span> </label>
              <label class="appendedInput" style="font-size:18px;padding-top:10px;">发起时间：<span class="badge badge-info" style="font-size:18px">{{ topic_ori_date }} </span></label>
              
            </div>
            <div style="float:left;padding-top:10px;padding-left:30px;">                
                <label class="appendedInput" style="font-size:18px">原创微博条数：<span class="badge badge-warning" style="font-size:18px"> {{ blog_ori_count }} </span></label>
                <label class="appendedInput" style="font-size:18px;padding-top:10px;">相关微博条数：<span class="badge badge-warning" style="font-size:18px"> {{ blog_rel_count }} </span></label>                
            </div>
            <div style="float:left;padding-top:10px;padding-left:30px;">
              <label class="appendedInput" style="font-size:18px">原创微博比例：{{ blog_ori_account }}</label>
              <!--<label class="appendedInput" style="font-size:18px;padding-top:10px;">领袖人数：{{ topic_leader_count }} </label>-->
            </div>
          </div>
        </div>
      </div>
    </div><!--上侧基本信息-->
          
    <div class="row-fluid" style="padding-top:20px;">
      <div class="span12" id="index-tabs">
        <ul class="nav nav-pills tab_container">
          <li class="btn span2" style="width:150px;height:20px;"><a href="/propagate/topic_ajax_weibos/?keyword={{keyword}}&time={{dur_time}}" align="center" style="padding-top: 2px;padding-bottom: 2px;color:black;">关联微博</a></li>
          <li class="btn span2" style="width:150px;height:20px;"><a href="/propagate/topic_ajax_trend/?keyword={{keyword}}&time={{dur_time}}" align="center" style="padding-top: 2px;padding-bottom: 2px;color:black;">传播数量走势</a></li>
          <li class="btn span2" style="width:150px;height:20px;"><a href="/propagate/topic_ajax_spatial/?keyword={{keyword}}&time={{dur_time}}" align="center" style="padding-top: 2px;padding-bottom: 2px;color:black;">地理分布</a></li>
          <li class="btn span2" style="width:150px;height:20px;"><a href="/propagate/topic_ajax_stat/?keyword={{keyword}}&time={{dur_time}}" align="center" style="padding-top: 2px;padding-bottom: 2px;color:black;">传播指标</a></li>
          <li class="btn span2" style="width:150px;height:20px;"><a href="/propagate/topic_ajax_userfield/?keyword={{keyword}}&time={{dur_time}}" align="center" style="padding-top: 2px;padding-bottom: 2px;color:black;">关键人员统计</a></li>
          <li class="btn span2 btn-primary" style="width:150px;height:20px;"><a href="/gexf/show_forest/?keyword={{keyword}}&time={{dur_time}}" align="center" style="padding-top: 2px;padding-bottom: 2px;color:black;">传播路径</a></li>         
        </ul>
        <div id="content_container">
            <div class="container-fluid">
                <div class="masthead">
                </div>
                <div class="sigma-parent">
                    <div class="sigma-expand" id="sigma">
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block script %}
    <script src="{{ url_for('static', filename='js/sigma.min.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/identify/sigma.parseGexf.js') }}" type="text/javascript"></script>

    <script>
        var sigInst;
        function graph_request_callback(data){
            sigInst = sigma.init($('#sigma')[0]).drawingProperties({
                defaultLabelColor: '#fff'
            }).graphProperties({
                minNodeSize: 0.5,
                maxNodeSize: 5
            });

            sigInst.parseGexf(data);

            (function(){
                var popUp;

                function attributesToString(attr) {
                    return '<ul>' +
                        attr.map(function(o){
                            if (o.attr == "img_url") {
                                return '<img src="' + o.val +'" >'
                            }
                            if (o.attr == "weibo_url") {
                                return '<a href="' + o.val +'" target="_blank" >点击访问此微博</a>'
                            }
                            return '<li>' + o.attr + ' : ' + o.val + '</li>';
                        }).join('') +
                    '</ul>';
                }

                function showNodeInfo(event) {
                    popUp && popUp.remove();

                    var node;
                    sigInst.iterNodes(function(n){
                        node = n;
                    },[event.content[0]]);

                    popUp = $(
                        '<div class="node-info-popup"></div>'
                    ).append(
                        attributesToString( node['attr']['attributes'] )
                    ).attr(
                        'id',
                        'node-info'+sigInst.getID()
                    ).mouseleave(
                        hideNodeInfo
                    ).css({
                        'display': 'inline-block',
                        'border-radius': 3,
                        'padding': 5,
                        'background': '#fff',
                        'color': '#000',
                        'box-shadow': '0 0 4px #666',
                        'position': 'absolute',
                        'left': node.displayX,
                        'top': node.displayY+15
                   });

                   $('ul',popUp).css('margin','0 0 0 20px');
                   $('#sigma').append(popUp);
                }

                function hideNodeInfo(event) {
                    popUp && popUp.remove();
                    popUp = false;
                }

                sigInst.bind('overnodes',showNodeInfo).draw();
            })();
        }
        function load_forest(){
            if(sigInst){
                $('#sigma').remove();
                $('#sigma').html();
            }
            $.ajax({
                url: "/gexf/forest/{{topic_id}}",
                dataType: 'xml',
                type: "GET",
                success: function (data) {
                    // (requires "sigma.parseGexf.js" to be executed)
                    console.log(data);
                    graph_request_callback(data);
                },
                error: function(result) {
                    console.log(result);
                    //$("#loading_network_data").text("暂无结果!");
                    console.log("Status: " + result.status);
                    console.log("Status: " + result.textStatus);
                    console.log("Error: " + result.errorThrown); 
              }
            })
        }
        load_forest();
    </script>
{% endblock script %}