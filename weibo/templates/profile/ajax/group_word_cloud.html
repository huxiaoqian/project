{% extends 'profile/ajax/ajax_layout.html' %}

{% block body %}     
<form class="form-inline">
    <button2 type="button" class="btn btn-primary" id="editor_save"><i class="icon-search"></i>下载svg</button2>
</form>
<div id='d3_cloud'></div>
<canvas type="hidden" id="svgtoimg" width="1000px" height="600px"></canvas> 


<script src="/static/js/profile/d3.v3.min.js"></script>
<script src="/static/js/profile/d3.layout.cloud.js"></script>
<script src="/static/js/profile/rgbcolor.js"></script> 
<script src="/static/js/profile/StackBlur.js"></script>
<script src="/static/js/profile/canvg.js"></script> 


  <script>
function defscale(count, mincount, maxcount, minsize, maxsize){
  if(maxcount == mincount){
    return (maxsize + minsize) / 2.0
  }else{
    return minsize + (maxsize - minsize) * Math.pow((count * 1.0 / (maxcount - mincount)), 3)
  }
}

function defrotate(count, mincount, maxcount){
  if(count < (maxcount + mincount) / 2){
      return 0;
  }else{
      return 0;
  }
}

function deffillcolor(text){
  //console.log(new RegExp("#.*?#", "g").test(text));
  //if())
}

function display_d3_cloud(data){
  var widthpixel = 936;
  var heightpixel = 400;
  var fill = d3.scale.category20();
  var FONT_STYLE = "SimHei";//Microsoft YaHei,SimSun,SimHei,STHeiti//Boopee";//"IMPACT"、"Lucida Sans"、"Loved by the King"
  var wordcounts = data;
  var counts = new Array();
  for(var wordcount in wordcounts){
    counts.push(parseFloat(wordcounts[wordcount]["size"]));
  }
  var maxcount = Math.max.apply(Math, counts);
  var mincount = Math.min.apply(Math, counts);
  var maxsize = 100;
  var minsize = 15;
  var wordsize = [];
  for(var wordcount in wordcounts){
    var count = parseFloat(wordcounts[wordcount]["size"]);
    var word = wordcounts[wordcount]["text"];
    var size = defscale(count, mincount, maxcount, minsize, maxsize);
    var rotate = defrotate(count, mincount, maxcount);
    //deffillcolor(word);
    wordsize.push({"text": word, "size": size});
  }


  d3.layout.cloud().size([widthpixel, heightpixel])
      .words(wordsize)
      //.rotate(function(d) { return d.rotate;})
      .rotate(function() { return ~~(Math.random() * 2) * 90; })//随机旋转
      .font(FONT_STYLE)
      .fontSize(function(d) { return d.size; })
      .on("end", draw)
      .start();

  function draw(words) {
    d3.select("#d3_cloud").append("svg")
        .attr("width", widthpixel)
        .attr("height", heightpixel)
      .append("g")
        .attr("transform", "translate(" + [widthpixel >> 1, heightpixel >> 1] + ")")
      .selectAll("text")
        .data(words)
      .enter().append("text")
        .style("font-size", function(d) { return d.size + "px"; })
        .style("font-family", FONT_STYLE)
        .style("fill", function(d, i) { 
          return fill(i); 
        })
        .attr("text-anchor", "middle")
        .attr("transform", function(d) {
          
          return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";

        })
        .text(function(d) { return d.text; });
  }
}

  $(document).ready(function(){
    $("#topic_type").change(function(){  
      changChild($(this).val());  
    });
    $.ajax({
        url: "/profile/group_topic/{{field}}?interval=90&sort=prob&limit=200&topic_type=lda",
        dataType: 'json',   
        type: "GET",   
        success: function (data) {
          display_d3_cloud(data);
        }
    });
  });
  </script>
  <script>
  $("#editor_save").click(function() {
   // Get the d3js SVG element
	 var tmp = document.getElementById("d3_cloud");
	 var svg = tmp.getElementsByTagName("svg")[0];
	 // Extract the data as SVG text string
	 var svg_xml = (new XMLSerializer).serializeToString(svg);

   // the canvg call that takes the svg xml and converts it to a canvas
   canvg('svgtoimg', svg_xml);
 
   // the canvas calls to output a png
   var canvas = document.getElementById("svgtoimg");
   //var img = canvas.toDataURL("image/png");
   var dataURL=canvas.toDataURL();
   window.open('', '_blank').location.href=dataURL;
   // do what you want with the base64, write to screen, post to server, etc...
    });
  </script>
   

{% endblock body %}

