{% extends 'profile/ajax/ajax_layout.html' %}

{% block body %}     
  <form class="form-inline">
    排序标准<select class="span2" name="sort_type" id="rb_sort_type">
        <option value="followers">粉丝数</option>
      </select>
    时间范围:
    <select class="span2" name="interval" id="rb_interval">
      <option value="-1">最近一周</option>
    </select>
    前<input type="number" name="limit" value="1000" min="1" max="1000" class="span2" id="limit" disabled>条，
      每页<input type="text" id="countperpage" name="countperpage" value="8" class="span1" disabled>
      条结果
    <button type="button" class="btn btn-primary" id="rank" onclick="submit_form();return false;"><i class="icon-search"></i>排序</button>
  </form>
  <table class="table table-hover" id="group_table">
    <thead>
      <tr>
        <th>博主ID</th>
        <th>博主昵称</th>
        <th>微博数</th>
        <th>粉丝数</th>
        <th>关注数</th>
        <th>是否认证</th>
        <th>性别</th>
      </tr>
    </thead>
    <tbody id="user_table">
    </tbody>
  </table>
  <div class="inputAppend"><a class="btn btn-small" id="out"><i class="icon-download-alt"></i> 导出</a></div>
  <div id="page-selection" class="pagination pagination-centered"></div>
  <script src="/static/js/profile/bootstrap.min.js"></script>
  <script src="/static/js/profile/jquery.bootpag.min.js"></script>
  <script>
  var countperpage_args = 8;
  var limit_arg = 1000;
  var sex_kv = {'m': '男', 'f': '女'};
  var v_kv = {'true': '是', 'false': '否'};
  function submit_form(){
      var interval_arg = $("#rb_interval")[0].value;
      var sort_arg = $("#rb_sort_type")[0].value;
      getRankData(countperpage_args, interval_arg, sort_arg, limit_arg);
  }
  function getRankData(countperpage_args, interval_arg, sort_arg, limit_arg){
    var total_page_number;
    $.ajax({
        url: "/profile/group_rank/{{field}}?page=1&countperpage=" + countperpage_args + "&limit=" + limit_arg,
        dataType: 'json',   
        type: "GET",
        success: function (data) {
          total_page_number = parseInt(data['pages']);
          var html = "";
          for(var i=0;i < data['users'].length;i += 1){
            user = data['users'][i];
            html += "<tr><td>" + user['id'] + "</td>";
            html += "<td>" + user['userName'] + "</td>";
            html += "<td>" + user['statusesCount'] + "</td>";
            html += "<td>" + user['followersCount'] + "</td>";
            html += "<td>" + user['friendsCount'] + "</td>";
            html += "<td>" + v_kv[user['verified']] + "</td>";
            html += "<td>" + sex_kv[user['gender']] + "</td></tr>";
          }
          $("#user_table").empty();
          $("#user_table").append(html);
          $('#page-selection').bootpag({
              total: total_page_number,
              maxVisible: 10
          }).on("page", function(event, /* page number here */ num){
               $("#user_table").empty();
               $.ajax({
                  url: "/profile/group_rank/{{field}}?page=" + num + "&countperpage=" + countperpage_args + "&limit=" + limit_arg,
                  dataType: 'json',   
                  type: "GET",
                  success: function (data) {
                    var html = "";
                    for(var i=0;i < data['users'].length;i += 1){
                      user = data['users'][i];
                      html += "<tr><td>" + user['id'] + "</td>";
                      html += "<td>" + user['userName'] + "</td>";
                      html += "<td>" + user['statusesCount'] + "</td>";
                      html += "<td>" + user['followersCount'] + "</td>";
                      html += "<td>" + user['friendsCount'] + "</td>";
                      html += "<td>" + v_kv[user['verified']] + "</td>";
                      html += "<td>" + sex_kv[user['gender']] + "</td></tr>";
                    }
                    $("#user_table").append(html);
                  }
                });
            });
        }
      });
  }
  $(document).ready(function(){
      var interval_arg = $("#rb_interval")[0].value;
      var sort_arg = $("#rb_sort_type")[0].value;
      getRankData(countperpage_args, interval_arg, sort_arg, limit_arg);
  })

  function exportTableToCSV($table, filename) {
                
            //  alert(filename);
                  var ta=$("#group_table");  
                  var $head = ta.find("thead");
                  var $body = ta.find("tbody");
                  var $r_head = $head.find("tr");
                  var $rows = $body.find("tr");
                  var tmpColDelim = String.fromCharCode(11); // vertical tab character
                  var tmpRowDelim = String.fromCharCode(0); // null character

              // actual delimiter characters for CSV format
                  var colDelim = ",";
                  var rowDelim = "\r\n";

              // Grab text from table into CSV formatted string
                  var c_head = $r_head.find("th");
                  var csv_head = '';
                  for(var count=0;count<c_head.length;count++){ 
                      if(count == (c_head.length-1)){
                          csv_head = csv_head + c_head[count].innerHTML + rowDelim;
                        }
                        else{
                          csv_head = csv_head + c_head[count].innerHTML + colDelim;
                        }
                    }
                                      
                csv = $rows.map(function (i, row) {
                  var $row = $(row),
                    $cols = $row.find('td');

                  return $cols.map(function (j, col) {
                      var $col = $(col);
                      var text = $col.text();
                      return text.replace('"', '"'); // escape double quotes                                                                 

                  }).get().join(tmpColDelim);

              }).get().join(tmpRowDelim).split(tmpRowDelim).join(rowDelim).split(tmpColDelim).join(colDelim);              

              csv = csv_head + csv;

              // Data URI
              csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csv);

            $(this)
                .attr({
                  'download': filename,
                    'href': csvData,
                    'target': '_blank'
              });
        }


        $("a[id='out']").on('click', function (event) {
          exportTableToCSV.apply(this, [$('#dvData>table'), 'Group_Rank_Bloggers.csv']);
          alert("导出成功！");
        });
  </script>
{% endblock body %}

